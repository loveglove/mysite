// @author Justin Lam
// @version v2:3bc3fc0
!function(e){var t,r,n,o,i,s,a={ready:null,store:{Property:{},Record:{}},analytics:{},context:{},api:{},initFile:{},util:{},interface:{},idp:{},cfg:{HOST:"http://api.flybits.com",CTXREPORTDELAY:6e4,analytics:{REPORTDELAY:36e5,REPORTDELAYUNIT:"milliseconds",MAXSTORESIZE:100},store:{SDKPROPS:"flb.sdk.properties",RESOURCEPATH:"./res",DEVICEID:"flb_device",USERTOKEN:"flb_usertoken",USER:"flb_user",USERTOKENEXP:"flb_usertoken_expiry",PROJECTID:"flb_projectid",IDPTYPE:"flb_idptype",ANALYTICSLASTREPORTED:"flb_analytics_lastreported",ANALYTICSLASTREPORTATTEMPTED:"flb_analytics_lastreportattempted",CONTEXTLASTREPORTED:"flb_context_lastreported",CONTEXTLASTREPORTATTEMPTED:"flb_context_lastreportattempted"},res:{CONTEXT:"/context/ctxdata",UNAUTHENTICATE:"/sso/auth/logout",AUTHENTICATE:"/sso/auth/authenticate",ANONYMOUSAUTH:"/sso/auth/anonymous",OAUTH:"/sso/auth/oauth",SIGNEDLOGIN:"/sso/auth/signedLogin",REFRESHAUTH:"/sso/auth/refreshToken",AUTHUSER:"/sso/auth/me",AUTHPROJECT:"/sso/auth/project",REQRESETEMAIL:"/sso/auth/sendResetPasswordEmail",REQCONFIRMEMAIL:"/sso/auth/sendConfirmEmail",CONTENTS:"/kernel/content/instances",RELEVANTCONTENTS:"/kernel/experiences/contents"}},VERSION:"v2:3bc3fc0"},c=function(){var e=new a.Deferred;return a.store.Property.ready.then(function(){return a.Session._restoreState()}).then(function(){return a.Session._deviceID?Promise.resolve():(a.Session._deviceID=u(),a.Session._persistState())}).then(function(){e.resolve()}).catch(function(t){e.reject(t)}),e.promise},u=function(){if("object"==typeof window){var e=navigator.userAgent;return a.util.Browser.getName(e)||a.util.Obj.guid()}return a.util.Obj.guid()},p=function(){var e={physicalDeviceId:a.Session._deviceID,sdkVersion:a.VERSION};return"object"==typeof window?(e.make=navigator.userAgent,e.deviceType="browser"):(e.osVersion=process.version,e.deviceType="node"),a.Session.userAgent=e,e},l=function(){a.context.Manager.reportDelay=a.cfg.CTXREPORTDELAY,a.analytics.Manager.reportDelay=a.cfg.analytics.REPORTDELAY,a.analytics.Manager.reportDelayUnit=a.cfg.analytics.REPORTDELAYUNIT,a.analytics.Manager.maxStoreSize=a.cfg.analytics.MAXSTORESIZE};a.initFile.server=function(e){return function(e){if(!e)return console.log("> config file path not provided: using defaults"),!1;try{var t=k.readFileSync(e)}catch(t){throw new Error("Config file read failed: "+e)}try{a.cfg=a.util.Obj.extend(a.cfg,JSON.parse(t))}catch(t){throw new Error("Malformed Config file: "+e)}}(e),c().then(function(){p(),l(),L.resolve(a.cfg)}).catch(function(e){L.reject(e)}),a.ready},a.initFile.browser=function(e){var t,r;return(t=e,r=new a.Deferred,fetch(t).then(function(e){if(200!==e.status)throw(new a.Validation).addError("Configuration file not found","Reverting to default configuration. No configuration found at:"+t,{code:a.Validation.type.INVALIDARG,context:"url"});return e.json()}).then(function(e){a.cfg=a.util.Obj.extend(a.cfg,e),r.resolve(a.cfg)}).catch(function(e){e instanceof a.Validation?r.reject(e):r.reject((new a.Validation).addError("Failed to read configuration file.","Reverting to default configuration. Configuration format incorrect at:"+t,{code:a.Validation.type.MALFORMED,context:"url"}))}),r.promise).then(function(){return c()}).then(function(){p(),l(),L.resolve(a.cfg)}).catch(function(e){L.reject(e)}),a.ready},a.init=function(e){return e=e||{},a.cfg=a.util.Obj.extend(a.cfg,e),c().then(function(){p(),l(),L.resolve(a.cfg)}).catch(function(e){L.reject(e)}),a.ready},a.Deferred=function(){Promise.settle=function(e){var t=e.map(function(e){return e.then(function(e){return{result:e,status:"resolved"}},function(e){return{result:e,status:"rejected"}})});return Promise.all(t)};return function(){var e=this;this.promise=new Promise(function(t,r){e.resolve=t,e.reject=r}),this.then=this.promise.then.bind(this.promise),this.catch=this.promise.catch.bind(this.promise)}}(),a.util.Obj=(t=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},(r={guid:function(e){var r="js";if(e&&e>0){for(var n=0;n<e;n++)r+="js"!==r?"-"+t():t();return r}return"js"+t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},removeObject:function(e,t,r){var n=e.indexOf(t);if(r){var o=e.filter(r);o.length>0&&(n=e.indexOf(o[0]))}return n>=0?e.splice(n,1):e},debounce:function(e,t,r){var n;return function(){var o=this,i=arguments,s=r&&!n;clearTimeout(n),n=setTimeout(function(){n=null,r||e.apply(o,i)},t),s&&e.apply(o,i)}},functionName:function(e){var t=/^function\s+([\w\$]+)\s*\(/.exec(e.toString());return t?t[1]:""},isNull:function(t){return null===t||t===e||""===t},toLocaleValueMap:function(e,t){for(var r={},n=e.locales||e.localizations,o=n?Object.keys(n):[],i=0;i<o.length;i++){var s=o[i],a=n[s][t];a&&(r[s]=a)}return r}}).extend=function(){function e(e){return e&&"object"==typeof e&&"[object RegExp]"!==Object.prototype.toString.call(e)&&"[object Date]"!==Object.prototype.toString.call(e)}function t(t,r){var o;return r&&!0===r.clone&&e(t)?n((o=t,Array.isArray(o)?[]:{}),t,r):t}function r(r,o,i){var s=r.slice();return o.forEach(function(o,a){void 0===s[a]?s[a]=t(o,i):e(o)?s[a]=n(r[a],o,i):-1===r.indexOf(o)&&s.push(t(o,i))}),s}function n(o,i,s){var a,c,u,p,l=Array.isArray(i),d=(s||{arrayMerge:r}).arrayMerge||r;return l?Array.isArray(o)?d(o,i,s):t(i,s):(a=o,c=i,p=(u=s)&&u.mutate?a:{},e(a)&&Object.keys(a).forEach(function(e){p[e]=t(a[e],u)}),Object.keys(c).forEach(function(r){e(c[r])&&a[r]?p[r]=n(a[r],c[r],u):p[r]=t(c[r],u)}),p)}return n.all=function(e,t){if(!Array.isArray(e)||e.length<2)throw new Error("first argument should be an array with at least two elements");return e.reduce(function(e,r){return n(e,r,t)})},n}(),r),a.util.Api=(n=a.Deferred,o=a.util.Obj,i={method:"GET",credentials:"omit"},s={flbFetch:function(e,t){return t=t||{},this.fetch(e,o.extend({headers:{"Content-Type":"application/json","x-user-agent":JSON.stringify(a.Session.userAgent),"x-authorization":a.Session.userToken},credentials:"omit",respType:"json"},t))},fetch:function(e,t){t=t||{};var r=new n,c=o.extend({},i),u="json"===t.respType;return delete t.respType,c=o.extend(c,t),fetch(e,c).then(this.checkResult).then(this.getResultBody).then(function(e){if(u)try{e.body=s.parseResponse(e.body),r.resolve(e)}catch(e){r.reject((new a.Validation).addError("Request Failed","Unexpected server response.",{code:a.Validation.type.MALFORMED}))}else r.resolve(e)}).catch(function(e){s.getResultBody(e).then(function(t){var n=s.parseErrorMsg(t.body);r.reject((new a.Validation).addError("Request error",n,{serverCode:e.status}))})}),r.promise},checkResult:function(e){if(e.status>=200&&e.status<300)return e;throw e},getResultBody:function(e){var t=new n;if(e&&e.text){var r={};e.headers.forEach(function(e,t){r[t]=e}),e.text().then(function(e){t.resolve({body:e,headers:r})}).catch(function(e){t.reject(e)})}else t.resolve({body:"",headers:{}});return t.promise},getResultJSON:function(e){return e.json()},toURLParams:function(e){for(var t=Object.keys(e),r=t.length,n="";r--;){var o=t[r];""!==n&&(n+="&"),n+=o+"="+encodeURIComponent(e[o])}return n},htmlEncode:function(e){return encodeURIComponent(e)},htmlDecode:function(t){return t.replace(/&#?(\w+);/g,function(t,r){return isNaN(r)&&(chars={quot:34,amp:38,lt:60,gt:62,nbsp:160,copy:169,reg:174,deg:176,frasl:47,trade:8482,euro:8364,Agrave:192,Aacute:193,Acirc:194,Atilde:195,Auml:196,Aring:197,AElig:198,Ccedil:199,Egrave:200,Eacute:201,Ecirc:202,Euml:203,Igrave:204,Iacute:205,Icirc:206,Iuml:207,ETH:208,Ntilde:209,Ograve:210,Oacute:211,Ocirc:212,Otilde:213,Ouml:214,times:215,Oslash:216,Ugrave:217,Uacute:218,Ucirc:219,Uuml:220,Yacute:221,THORN:222,szlig:223,agrave:224,aacute:225,acirc:226,atilde:227,auml:228,aring:229,aelig:230,ccedil:231,egrave:232,eacute:233,ecirc:234,euml:235,igrave:236,iacute:237,icirc:238,iuml:239,eth:240,ntilde:241,ograve:242,oacute:243,ocirc:244,otilde:245,ouml:246,divide:247,oslash:248,ugrave:249,uacute:250,ucirc:251,uuml:252,yacute:253,thorn:254,yuml:255,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,permil:8240,lsaquo:8249,rsaquo:8250,spades:9824,clubs:9827,hearts:9829,diams:9830,oline:8254,larr:8592,uarr:8593,rarr:8594,darr:8595,hellip:133,ndash:150,mdash:151,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,brkbar:166,sect:167,uml:168,die:168,ordf:170,laquo:171,not:172,shy:173,macr:175,hibar:175,plusmn:177,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,sup1:185,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,Alpha:913,alpha:945,Beta:914,beta:946,Gamma:915,gamma:947,Delta:916,delta:948,Epsilon:917,epsilon:949,Zeta:918,zeta:950,Eta:919,eta:951,Theta:920,theta:952,Iota:921,iota:953,Kappa:922,kappa:954,Lambda:923,lambda:955,Mu:924,mu:956,Nu:925,nu:957,Xi:926,xi:958,Omicron:927,omicron:959,Pi:928,pi:960,Rho:929,rho:961,Sigma:931,sigma:963,Tau:932,tau:964,Upsilon:933,upsilon:965,Phi:934,phi:966,Chi:935,chi:967,Psi:936,psi:968,Omega:937,omega:969},chars[r]!==e&&(r=chars[r])),String.fromCharCode(r)})},base64Decode:function(e){return decodeURIComponent(Array.prototype.map.call(atob(e),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))},parseResponse:function(e){return JSON.parse(e,function(e,t){return"string"==typeof t?s.htmlDecode(t):t})},parseErrorMsg:function(e){try{var t=this.parseResponse(e)}catch(e){return"Malformed server response"}return(t=t.error||t.errors||t)instanceof Array&&(t=t[0]),t?t.exceptionMessage||t.message||t.messageJSON||t.detail||"Unexpected error has occurred":null},parsePaging:function(e,t){return{offset:e[t=t||"pagination"].offset,limit:e[t].limit,total:e[t].totalRecords}},createNextPageCall:function(e,t,r){return r.offset+r.limit>=r.total?null:(t=t||{},function(){return t.paging={limit:r.limit,offset:r.offset+r.limit},e(t)})}}),a.util.Browser=function(){a.Deferred;return{getCookie:function(e){var t=("; "+document.cookie).split("; "+e+"=");return 2==t.length?t.pop().split(";").shift():null},setCookie:function(e,t,r){var n="";r&&(n="; expires="+r.toGMTString()),document.cookie=e+"="+t+n+"; path=/"},getName:function(e){var t,r=(e=e?e.toLowerCase():"").indexOf("chrome")>-1,n=e.indexOf("chromium")>-1,o=e.indexOf("firefox")>-1,i=(e.indexOf("applewebkit")>-1||e.indexOf("safari")>-1)&&!r&&!n,s=e.indexOf("msie")>-1||e.indexOf(".net")>-1,a=e.indexOf("opr")>-1||e.indexOf("opera")>-1,c=e.indexOf("mobi")>-1;return r?t="chrome":n?t="chromium":o?t="firefox":i?t="safari":s?t="ie":a&&(t="opera"),t&&c&&(t+="_mobile"),t}}}(),a.util.Geo={_toDeg:function(e){return 180*e/Math.PI},_toRad:function(e){return e*Math.PI/180},getBoundingBox:function(e){if(!e||e.length<3)throw(new a.Validation).addError("Invalid Argument","Must provide an array of lat,lng coordinates greater than 2.",{code:a.Validation.type.INVALIDARG});for(var t=e[0].lat,r=e[0].lat,n=e[0].lng,o=e[0].lng,i=1;i<e.length;i++){var s=e[i];t=s.lat<t?s.lat:t,r=s.lat>r?s.lat:r,n=s.lng<n?s.lng:n,o=s.lng>o?s.lng:o}return{min:{lat:t,lng:n},max:{lat:r,lng:o}}},getCenter:function(e){if(!e||e.length<3)throw(new a.Validation).addError("Invalid Argument","Must provide an array of lat,lng coordinates greater than 2.",{code:a.Validation.type.INVALIDARG});var t=this.getBoundingBox(e);return{lat:(t.max.lat+t.min.lat)/2,lng:(t.max.lng+t.min.lng)/2}},getBearing:function(e,t){var r=t.lng-e.lng,n=Math.sin(r)*Math.cos(t.lat),o=Math.cos(e.lat)*Math.sin(t.lat)-Math.sin(e.lat)*Math.cos(t.lat)*Math.cos(r);return 360-(this._toDeg(Math.atan2(n,o))+360)%360}},a.interface.ContextPlugin={isSupported:function(){},getState:function(){},_toServerFormat:function(e){}},a.interface.IDP={getURL:function(){},getPayload:function(){}},a.interface.KeyDataStore={getSize:function(){},set:function(e,t){},get:function(e){},getKeys:function(){},clear:function(){}},a.interface.Localizable={_fromLocaleJSON:function(e){},_toLocaleJSON:function(e){}},a.interface.PropertyStore={isSupported:function(){},getItem:function(e){},setItem:function(e,t){},removeItem:function(e){}},a.interface.Serializable={fromJSON:function(e){},toJSON:function(){}};var d,f=function(){function e(){}return e.prototype={implements:function(e){this._interfaces||(this._interfaces=[]),this._interfaces.push(e)}},e}(),Path=function(){function Path(){this.nodes=[]}return Path.prototype.getNode=function(e){return this.nodes.filter(function(t){return a.util.Obj.functionName(t.constructor)===e})[0]},Path.prototype.append=function(e){return this.nodes.push(e),this},Path.prototype.serialize=function(){for(var e="",t=0;t<this.nodes.length;t++)e+="/"+this.nodes[t]._pathName,this.nodes[t].id&&(e+="/"+this.nodes[t].id);return e},Path}(),h=(((d=function(e){f.call(this),this.id,e&&e.id&&(this.id=e.id)}).prototype=Object.create(f.prototype)).constructor=d,d.prototype.reqKeys={id:"id"},d);a.Content=function(){var t=a.util.Api;function Content(e){h.call(this,e),e&&this.fromJSON(e)}return Content.prototype=Object.create(h.prototype),Content.prototype.constructor=Content,Content.prototype.implements("Serializable"),Content.prototype.implements("Localizable"),Content.prototype.types=Content.types={DEFAULT:"default",SURVEY:"SurveyQuestions"},Content.prototype._pathName=Content._pathName="content/instances",Content.prototype.reqKeys=Content.reqKeys={name:"name",description:"description",createdDate:"createdAt",lastModifiedDate:"modifiedAt",id:"id"},Content.prototype._fromLocaleJSON=function(e){return{name:e.name,description:e.description}},Content.prototype._toLocaleJSON=function(e){return{name:e.name,description:e.description}},Content.prototype.parseContents=function(e){var r=t.parsePaging(e),n=this;return{result:e.data.map(function(e){var t=(new Path).append(n);try{return new a.ContentData(e,t)}catch(t){throw console.error(t),(new Validation).addError("Parse Failed","Failed to parse Content data model.",{code:Validation.type.MALFORMED,context:e})}}),nextPageFn:t.createNextPageCall(a.api.ContentData.getAll,{contentID:n.id},r)}},Content.prototype.getData=function(){var e=this;if(this.data&&this.data.result&&this.data.result.length>0)return Promise.resolve(this.data.result[0].payload);var t=new a.Deferred;return a.api.ContentData.getAll({contentID:this.id}).then(function(r){r&&r.result&&r.result.length>0?(e.data=r,t.resolve(r.result[0].payload)):t.resolve()}).catch(function(e){t.reject(e)}),t.promise},Content.prototype.fromJSON=function(t){var r=this;r.id=t.id,r.tenantID=t.tenantId,r.templateID=t.templateId,r.type=t.templateType||Content.types.DEFAULT,r.iconURL=t.iconUrl,r.createdDate=t.createdAt?new Date(1e3*t.createdAt):null,r.lastModifiedDate=t.modifiedAt?new Date(1e3*t.modifiedAt):null,r.locales={},(t.localizations?Object.keys(t.localizations):[]).forEach(function(e){r.locales[e]=r._fromLocaleJSON(t.localizations[e])}),r.linkedFields=t.linkedFields,r.labels=t.labels||[],r.data=t.content?this.parseContents(t.content):e},Content.prototype.toJSON=function(){var e=this,t={iconUrl:e.iconURL,localizations:{},labels:e.labels};(e.createdDate&&(t.createdAt=Math.round(e.createdDate.getTime()/1e3)),e.lastModifiedDate&&(t.modifiedAt=Math.round(e.lastModifiedDate.getTime()/1e3)),Object.keys(e.locales).length>0)&&Object.keys(e.locales).forEach(function(r){t.localizations[r]=e._toLocaleJSON(e.locales[r])});return e.id&&(t.id=e.id),e.tenantID&&(t.tenantId=e.tenantID),e.templateID&&(t.templateId=e.templateID),e.type&&(t.templateType=e.type),t},Content.getInstance=function(e){var t=e.content&&e.content.data&&e.content.data.length&&e.content.data[0].questions;return e.templateType===Content.types.SURVEY&&e.surveyMetadata||t?new a.Survey(e):new Content(e)},Content}(),a.ContentData=function(){function ContentData(e,t){h.call(this,e),this.id=e._id||e.id,delete e._id,delete e.id,this.path=t||new Path,this.path.append(this),e&&this.fromJSON(e)}ContentData.prototype=Object.create(h.prototype),ContentData.prototype.constructor=ContentData,ContentData.prototype.implements("Serializable"),ContentData.prototype._pathName=ContentData._pathName="data";var e=function(r,n){return r instanceof Object&&!Array.isArray(r)?t(r,n):Array.isArray(r)?r.map(function(t){return e(t,n)}):r},t=function(t,r){var n={};return Object.keys(t).forEach(function(o){var i=t[o];"_id"===o?o="id":"localizations"===o&&(o="locales");var s=o+".pagination";t.hasOwnProperty(s)?n[o]=new a.PagedData({data:i,paging:t[s],key:o,path:r}):o.indexOf(".pagination")<0&&(n[o]=e(i,r))}),n},r=function(e){return e instanceof a.PagedData?e.toJSON():e instanceof Object&&!Array.isArray(e)?n(e):Array.isArray(e)?e.map(function(e){return r(e)}):e},n=function(e){var t={};return Object.keys(e).forEach(function(n){var o=e[n];t[n="locales"===n?"localizations":n]=r(o)}),t};return ContentData.prototype.fromJSON=function(e){this.payload=t(e,this.path)},ContentData.prototype.toJSON=function(){return n(this.payload)},ContentData}(),a.PagedData=function(){var e=a.util.Api,t=a.Deferred;function PagedData(t){if(h.call(this,t),this.data=[],t){this.path=t.path,this.key=t.key;var r={total:t.paging.totalRecords,limit:t.paging.limit,offset:t.paging.offset};this.nextPageFn=e.createNextPageCall(a.api.ContentData.getPagedData,{path:this.path,key:this.key},r)}t&&t.data&&this.fromJSON(t.data)}return PagedData.prototype=Object.create(h.prototype),PagedData.prototype.constructor=PagedData,PagedData.prototype.implements("Serializable"),PagedData.prototype.hasNext=function(){return this.nextPageFn},PagedData.prototype.getNext=function(){if(!this.hasNext())return Promise.resolve([]);var e=new t,r=this;return this.nextPageFn().then(function(t){r.nextPageFn=t.nextPageFn,r.data.push.apply(r.data,t.result),e.resolve(t.result)}),e.promise},PagedData.prototype.fetchAll=function(){var e=new a.Deferred,t=this,r=function(){t.hasNext()?t.getNext().then(function(){r()}).catch(function(t){e.reject(t)}):e.resolve(t.data)};return r(),e.promise},PagedData.prototype.fromJSON=function(e){for(var t=0;t<e.length;t++){var r=e[t];r.constructor===Object&&r.hasOwnProperty("localizations")&&(r.locales=r.localizations,delete r.localizations),this.data.push(r)}},PagedData.prototype.toJSON=function(){for(var e=[],t=0;t<this.data.length;t++){var r=this.data[t];r.constructor===Object&&r.hasOwnProperty("locales")&&(r.localizations=r.locales,delete r.locales),e.push(r)}return e},PagedData}(),a.Survey=function(){var Content=a.Content;function Survey(e){Content.call(this,e),this.questions=[];var t=e.surveyMetadata||{};this.resultID=t.surveyResultInstanceID,this.answerID=t.surveyAnswersInstanceID,this.data&&this.parseQuestions(this.data)}Survey.prototype=Object.create(Content.prototype),Survey.prototype.constructor=Survey,Survey.prototype.implements("Serializable"),Survey.prototype.parseQuestions=function(e){var t={};e&&e.result&&e.result.length&&(t=e.result[0].payload),t.questions&&t.questions.data&&(this.questions=t.questions.data.map(function(e){return new a.SurveyQuestion(e)}))},Survey.prototype.getQuestions=function(){var e,t=this,r=new a.Deferred;return this.getData().then(function(t){return(e=t.questions).fetchAll()}).then(function(){t.questions=e.data.map(function(e){return new a.SurveyQuestion(e)}),r.resolve(t.questions)}).catch(function(e){r.reject(e)}),r.promise};var e=function(t,r){return function(){var n,o=new a.Deferred;return t().then(function(e){var t=e.result.map(function(e){return a.SurveyResponse.parseResponse(e,r)});return n=e.nextPageFn,Promise.settle(t)}).then(function(t){o.resolve({result:t.map(function(e){return e.result}),contentID:r.answerID,nextPageFn:e(n,r)})}).catch(function(e){o.reject(e)}),o.promise}};return Survey.prototype.getResponses=function(){var t=this;return e(function(){return a.api.ContentData.getAll({contentID:t.answerID,paging:{limit:2}})},t)()},Survey.prototype.validate=function(){return this.questions.reduce(function(e,t){return e.merge(t.validate())},new a.Validation)},Survey.prototype.submit=function(){for(var e=new a.Deferred,t=new y({id:this.answerID,surveyID:this.id}),r=0;r<this.questions.length;r++)t.parseAnswer(this.questions[r]);return a.api.ContentData.submitData(t.data).then(function(t){e.resolve(t)}).catch(function(t){e.reject(t)}),e.promise},Survey}();var y=function(){var Content=a.Content;function e(e){Content.call(this,e),this.surveyID=e.surveyID,this.qAnswers=[],this.path=(new Path).append(this),this.data=new a.ContentData({},this.path),this.data.payload={surveyId:this.surveyID,answers:this.qAnswers}}return e.prototype=Object.create(Content.prototype),e.prototype.constructor=e,e.prototype._pathName=e._pathName="content/survey/instances",e.prototype.parseAnswer=function(e){return e.id&&!a.util.Obj.isNull(e.answer)&&this.qAnswers.push({questionNumber:e.id,answer:e.answer instanceof Array?e.answer:[e.answer+""]}),this},e}();a.SurveyChoice=function(){return function(e){this.key=e.key,this.title=a.util.Obj.toLocaleValueMap(e,"value")}}(),a.SurveyQuestion=function(){function SurveyQuestion(t){this.isRequired=!1,this.id=0,this.choices=[],this.title={},this.type="shortAnswer",this.meta={number:{}},this.answer=e,this.validation=e,t&&this.fromJSON(t)}return SurveyQuestion.prototype.types=SurveyQuestion.types={SHORTANSWER:"shortAnswer",LONGANSWER:"longAnswer",NUMBER:"number",MULTIPLECHOICE:"multipleChoice",CHECKBOXES:"checkboxes",DROPDOWN:"dropdown",DATE:"date",TIME:"time",LOCATION:"location",FILEUPLOAD:"fileUpload"},SurveyQuestion.prototype.fromJSON=function(e){e.metadata&&(this.meta=JSON.parse(e.metadata)),this.isRequired=this.meta.isRequired,this.id=e.questionNumber,this.type=this.meta.uiType,this.title=a.util.Obj.toLocaleValueMap(e,"question"),e.choices&&e.choices.length&&(this.choices=e.choices.map(function(e){return new a.SurveyChoice(e)}))},SurveyQuestion.prototype.setAnswer=function(e){if(this.type!==SurveyQuestion.types.CHECKBOXES&&e instanceof Array)throw(new a.Validation).addError("Invalid answer","Only CHECKBOXES type questions can contain multiple answers.",{context:e,code:a.Validation.type.INVALIDARG});return this.answer=e,this},SurveyQuestion.prototype.validate=function(){var e=E.getValidator(this);return this.validation=e.validate(),this.validation},SurveyQuestion}(),a.SurveyResponse=function(){function SurveyResponse(e){this.id,this.answers=[],e&&this.fromJSON(e)}return SurveyResponse.prototype.fromJSON=function(e){this.id=e.id},SurveyResponse.parseResponse=function(e,t){var r=new a.Deferred,n=new a.SurveyResponse(e);return e.payload.answers.fetchAll().then(function(e){n.answers=e.map(function(e){var r=t.questions.filter(function(t){return t.id===e.questionNumber})[0],n=e.answer[0];return r.choices.length&&(n=e.answer.map(function(e){return r.choices.filter(function(t){return t.key===e})[0]})),{answer:n,question:r}}),r.resolve(n)}).catch(function(e){r.reject(e)}),r.promise},SurveyResponse}();var m,g,v,E=(m=function(){function e(e){this.question=e}return e.prototype.validate=function(){var e=new a.Validation;if(this.question.isRequired)if(this.question.answer instanceof Array){var t=this.question.answer.filter(function(e){return a.util.Obj.isNull(e)});this.question.answer.length&&!t.length||e.addError("Missing answer","This is a required question.",{code:a.Validation.type.MISSINGARG,context:this.question})}else a.util.Obj.isNull(this.question.answer)&&e.addError("Missing answer","This is a required question.",{code:a.Validation.type.MISSINGARG,context:this.question});return e},e}(),g=function(){function e(e){m.call(this,e)}e.prototype=Object.create(m.prototype),e.prototype.constructor=e,e.prototype.validate=function(){var e=m.prototype.validate.call(this);isNaN(this.question.answer)&&e.addError("Invalid answer type","Answer must be a number.",{code:a.Validation.type.INVALIDARG,context:this.question});var t=this.question.meta;if(t&&t.number){var r=t.number;r.hasOwnProperty("min")&&this.question.answer<r.min&&e.addError("Invalid range","Answer must be greater than or equal to "+r.min,{code:a.Validation.type.INVALIDARG,context:this.question}),r.hasOwnProperty("max")&&this.question.answer>r.max&&e.addError("Invalid range","Answer must be less than or equal to "+r.max,{code:a.Validation.type.INVALIDARG,context:this.question}),r.hasOwnProperty("increment")&&(this.question.answer%((r.min||0)+r.increment!==0)||this.question.answer===(r.min||0))&&e.addError("Invalid range","Answer must be a multiple of "+((r.min||0)+r.increment),{code:a.Validation.type.INVALIDARG,context:this.question})}return e}}(),v=function(){function e(e){m.call(this,e)}e.prototype=Object.create(m.prototype),e.prototype.constructor=e,e.prototype.validate=function(){var e=m.prototype.validate.call(this);return this.question.answer.filter(function(e){return a.util.Obj.isEmpty(e)}).length&&e.addError("Invalid values","Cannot have null values",{code:a.Validation.type.INVALIDARG,context:this.question}),e}}(),{validatorMap:{shortAnswer:m,longAnswer:m,number:g,multipleChoice:m,checkboxes:v,dropdown:m},getValidator:function(e){return new(this.validatorMap[e.type]||m)(e)}});a.User=function(){var e=a.util.Obj;function User(e){h.call(this,e),e&&this.fromJSON(e)}return User.prototype=Object.create(h.prototype),User.prototype.constructor=User,User.prototype.implements("Serializable"),User.prototype.reqKeys=User.reqKeys=e.extend(h.prototype.reqKeys,{email:"email",firstName:"firstName",lastName:"lastName"}),User.prototype.fromJSON=function(e){this.email=e.email,this.firstName=e.firstName,this.lastName=e.lastName,this.isConfirmed=e.isConfirmed},User.prototype.toJSON=function(){var e={email:this.email,firstName:this.firstName,lastName:this.lastName,isConfirmed:this.isConfirmed};return this.id&&(e.id=this.id),e},User}(),a.Validation=function(){function Validation(){this.state=!0,this.errors=[],this.stacktrace="",this.setStackTrace()}return Validation.prototype={addError:function(e,t,r){this.state=!1;var n={header:e,message:t};return r&&(n.context=r.context,n.code=r.code,n.serverCode=r.serverCode),this.errors.push(n),this},merge:function(e){return Array.prototype.push.apply(this.errors,e.errors),this.state=this.errors.length<1,this},firstError:function(){return this.errors.length>0?this.errors[0]:null},setStackTrace:function(){var e=new Error;return e.name="FlybitsError",this.stacktrace=e.stack,this.stacktrace&&(this.stacktrace=this.stacktrace.split("\n").filter(function(e){return e.indexOf("Validation")<0}).join("\n")),this},toJSON:function(){return{state:this.state,errors:this.errors,stacktrace:this.stacktrace}}},Validation.prototype.type=Validation.type={},Validation.prototype.type.MALFORMED=Validation.type.MALFORMED=1e3,Validation.prototype.type.INVALIDARG=Validation.type.INVALIDARG=1001,Validation.prototype.type.MISSINGARG=Validation.type.MISSINGARG=1002,Validation.prototype.type.NOTFOUND=Validation.type.NOTFOUND=1003,Validation.prototype.type.CONNECTIONERROR=Validation.type.CONNECTIONERROR=1004,Validation.prototype.type.UNAUTHENTICATED=Validation.type.UNAUTHENTICATED=1005,Validation.prototype.type.RETRIEVALERROR=Validation.type.RETRIEVALERROR=1006,Validation.prototype.type.NOTSUPPORTED=Validation.type.NOTSUPPORTED=1007,Validation.prototype.type.UNEXPECTED=Validation.type.UNEXPECTED=1008,Validation}(),a.store.Property=function(){var e=a.Deferred,Validation=a.Validation,t=new e;return{ready:t.promise,init:function(){var r,n,o,i=this,s=(r=new e,n=[j,x,C,b,P,M],(o=function(){n.length<1&&r.reject((new Validation).addError("No supported property storage engines"));var e=n.shift();e.isSupported().then(function(){r.resolve(new e(a.cfg.store.SDKPROPS))}).catch(function(){o()})})(),r.promise);return s.then(function(e){i.storageEngine=e,t.resolve()}),s},remove:function(e){return this.storageEngine.removeItem(e)},set:function(e,t){return t?this.storageEngine.setItem(e,t):this.remove(e)},get:function(e){return this.storageEngine.getItem(e)}}}(),a.store.Record=function(){var e=a.Deferred,Validation=a.Validation,t=function(t){var r=new e,n=[j,x,P,M],o=function(){n.length<1&&r.reject((new Validation).addError("No supported property storage engines"));var e=n.shift();e.isSupported().then(function(){r.resolve(new e(t))}).catch(function(){o()})};return o(),r.promise};function r(r){f.call(this);var n=this;this.storeName=r||"flb.records."+Date.now();var o=new e;this.ready=o.promise,t(this.storeName).then(function(e){n.storageEngine=e,o.resolve()})}return r.prototype=Object.create(f.prototype),r.prototype.constructor=r,r.prototype.remove=function(e){return this.storageEngine.removeItem(e)},r.prototype.set=function(e,t){return t?this.storageEngine.setItem(e,t):this.remove(e)},r.prototype.get=function(e){return this.storageEngine.getItem(e)},r.prototype.keys=function(){return this.storageEngine.getKeys()},r.prototype.clear=function(){return this.storageEngine.clearAll()},r}();var S,I,D,T,O,A,w,N,User,R,b=function(){var e=a.Deferred,Validation=a.Validation,t=a.util.Browser;function r(){f.call(this)}return r.prototype=Object.create(f.prototype),r.prototype.constructor=r,r.prototype.implements("PropertyStore"),r.prototype.isSupported=r.isSupported=function(){var r=new e,n=new Validation;if("object"==typeof document&&"cookie"in document)try{t.setCookie("flbstoresupport","true"),t.setCookie("flbstoresupport","true",new Date(0)),r.resolve()}catch(e){r.reject(n.addError("Storage not supported","Access error:"+e,{context:"cookie"}))}else r.reject(n.addError("Storage not supported","Missing reference in namespace.",{context:"cookie"}));return r.promise},r.prototype.getItem=function(e){return Promise.resolve(t.getCookie(e))},r.prototype.setItem=function(e,r){return t.setCookie(e,r),Promise.resolve()},r.prototype.removeItem=function(e){return t.setCookie(e,"",new Date(0)),Promise.resolve()},r}(),P=function(){var e=a.Deferred,Validation=a.Validation;function t(e){f.call(this),e=e||"flb.general",this.storage=U.create({dir:a.cfg.store.RESOURCEPATH+"/"+e}),this.storage.initSync()}return t.prototype=Object.create(f.prototype),t.prototype.constructor=t,t.prototype.implements("PropertyStore"),t.prototype.isSupported=t.isSupported=function(){var t=new e,r=new Validation;return"object"==typeof k&&"object"==typeof U&&"string"==typeof __dirname?t.resolve():t.reject(r.addError("Storage not supported","Missing reference in namespace.",{context:"fs"})),t.promise},t.prototype.getItem=function(e){return this.storage.getItem(e)},t.prototype.setItem=function(e,t){return t?this.storage.setItem(e,t):this.removeItem(e)},t.prototype.removeItem=function(e){return this.storage.removeItem(e)},t.prototype.getKeys=function(){return Promise.resolve(this.storage.keys())},t.prototype.clearAll=function(){return this.storage.clear()},t}(),j=function(){var e=a.Deferred,Validation=a.Validation;function t(e){f.call(this),this.store=localforage.createInstance({name:e})}return t.prototype=Object.create(f.prototype),t.prototype.constructor=t,t.prototype.implements("PropertyStore"),t.prototype.isSupported=t.isSupported=function(){var t=new e,r=new Validation;return"object"==typeof window&&window.hasOwnProperty("localforage")?localforage.setItem("flbstoresupport",!0).then(function(){return localforage.removeItem("flbstoresupport")}).then(function(){t.resolve()}).catch(function(e){t.reject(r.addError("Storage not supported","Access error:"+e,{context:"localforage"}))}):t.reject(r.addError("Storage not supported","No library detected",{context:"localforage"})),t.promise},t.prototype.getItem=function(e){return this.store.getItem(e)},t.prototype.setItem=function(e,t){return this.store.setItem(e,t)},t.prototype.removeItem=function(e){return this.store.removeItem(e)},t.prototype.getKeys=function(){return this.store.keys()},t.prototype.clearAll=function(){return this.store.clear()},t}(),_=function(){function t(e){return new Promise(function(t,r){e.onsuccess=function(){t(e.result)},e.onerror=function(){r(e.error)}})}function r(e,r,n){var o,i=new Promise(function(i,s){t(o=e[r].apply(e,n)).then(i,s)});return i.request=o,i}function n(e,t,r){r.forEach(function(r){Object.defineProperty(e.prototype,r,{get:function(){return this[t][r]},set:function(e){this[t][r]=e}})})}function o(e,t,n,o){o.forEach(function(o){o in n.prototype&&(e.prototype[o]=function(){return r(this[t],o,arguments)})})}function i(e,t,r,n){n.forEach(function(n){n in r.prototype&&(e.prototype[n]=function(){return this[t][n].apply(this[t],arguments)})})}function s(e,t,n,o){o.forEach(function(o){o in n.prototype&&(e.prototype[o]=function(){return e=this[t],(n=r(e,o,arguments)).then(function(e){if(e)return new c(e,n.request)});var e,n})})}function a(e){this._index=e}function c(e,t){this._cursor=e,this._request=t}function u(e){this._store=e}function p(e){this._tx=e,this.complete=new Promise(function(t,r){e.oncomplete=function(){t()},e.onerror=function(){r(e.error)},e.onabort=function(){r(e.error)}})}function l(e,t,r){this._db=e,this.oldVersion=t,this.transaction=new p(r)}function d(e){this._db=e}return n(a,"_index",["name","keyPath","multiEntry","unique"]),o(a,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),s(a,"_index",IDBIndex,["openCursor","openKeyCursor"]),n(c,"_cursor",["direction","key","primaryKey","value"]),o(c,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(e){e in IDBCursor.prototype&&(c.prototype[e]=function(){var r=this,n=arguments;return Promise.resolve().then(function(){return r._cursor[e].apply(r._cursor,n),t(r._request).then(function(e){if(e)return new c(e,r._request)})})})}),u.prototype.createIndex=function(){return new a(this._store.createIndex.apply(this._store,arguments))},u.prototype.index=function(){return new a(this._store.index.apply(this._store,arguments))},n(u,"_store",["name","keyPath","indexNames","autoIncrement"]),o(u,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),s(u,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),i(u,"_store",IDBObjectStore,["deleteIndex"]),p.prototype.objectStore=function(){return new u(this._tx.objectStore.apply(this._tx,arguments))},n(p,"_tx",["objectStoreNames","mode"]),i(p,"_tx",IDBTransaction,["abort"]),l.prototype.createObjectStore=function(){return new u(this._db.createObjectStore.apply(this._db,arguments))},n(l,"_db",["name","version","objectStoreNames"]),i(l,"_db",IDBDatabase,["deleteObjectStore","close"]),d.prototype.transaction=function(){return new p(this._db.transaction.apply(this._db,arguments))},n(d,"_db",["name","version","objectStoreNames"]),i(d,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[u,a].forEach(function(t){t.prototype[e.replace("open","iterate")]=function(){var t,r=(t=arguments,Array.prototype.slice.call(t)),n=r[r.length-1],o=this._store||this._index,i=o[e].apply(o,r.slice(0,-1));i.onsuccess=function(){n(i.result)}}})}),[a,u].forEach(function(t){t.prototype.getAll||(t.prototype.getAll=function(t,r){var n=this,o=[];return new Promise(function(i){n.iterateCursor(t,function(t){t?(o.push(t.value),r===e||o.length!=r?t.continue():i(o)):i(o)})})})}),{open:function(e,t,n){var o=r(indexedDB,"open",[e,t]),i=o.request;return i.onupgradeneeded=function(e){n&&n(new l(i.result,e.oldVersion,i.transaction))},o.then(function(e){return new d(e)})},delete:function(e){return r(indexedDB,"deleteDatabase",[e])}}},x=function(){var t=a.Deferred,Validation=a.Validation,r="keyvaluepairs";function n(t){f.call(this),t=t||"flb.general",this.storeName=t,this._ready=_().open(t,e,function(e){e.createObjectStore(r)})}return n.prototype=Object.create(f.prototype),n.prototype.constructor=n,n.prototype.implements("PropertyStore"),n.prototype.isSupported=n.isSupported=function(){var e=new t,r=new Validation;return"object"==typeof window&&window.hasOwnProperty("indexedDB")&&"object"==typeof navigator&&(!/^Apple/.test(navigator.vendor)||/^Apple/.test(navigator.vendor)&&/AppleWebKit[/]60.*Version[/][89][.]/.test(navigator.appVersion))?e.resolve():e.reject(r.addError("Storage not supported","No compatible interface detected",{context:"indexedDB"})),e.promise},n.prototype.getItem=function(e){return this._ready.then(function(t){return t.transaction(r).objectStore(r).get(e)})},n.prototype.setItem=function(e,t){return this._ready.then(function(n){var o=n.transaction(r,"readwrite");return o.objectStore(r).put(t,e),o.complete})},n.prototype.removeItem=function(e){return this._ready.then(function(t){var n=t.transaction(r,"readwrite");return n.objectStore(r).delete(e),n.complete})},n.prototype.getKeys=function(){return this._ready.then(function(e){var t=e.transaction(r),n=[],o=t.objectStore(r);return(o.iterateKeyCursor||o.iterateCursor).call(o,function(e){e&&(n.push(e.key),e.continue())}),t.complete.then(function(){return n})})},n.prototype.clearAll=function(){return dbPromise.then(function(e){var t=e.transaction(r,"readwrite");return t.objectStore(r).clear(),t.complete})},n}(),C=function(){var e=a.Deferred,Validation=a.Validation;function t(){f.call(this),this.store=localStorage}return t.prototype=Object.create(f.prototype),t.prototype.constructor=t,t.prototype.implements("PropertyStore"),t.prototype.isSupported=t.isSupported=function(){var t=new e,r=new Validation;if("object"==typeof window&&window.hasOwnProperty("localStorage"))try{localStorage.setItem("flbstoresupport",!0),localStorage.removeItem("flbstoresupport"),t.resolve()}catch(e){t.reject(r.addError("Storage not supported","Access error:"+e,{context:"localStorage"}))}else t.reject(r.addError("Storage not supported","Missing reference in namespace.",{context:"localStorage"}));return t.promise},t.prototype.getItem=function(e){return Promise.resolve(this.store.getItem(e))},t.prototype.setItem=function(e,t){return this.store.setItem(e,t),Promise.resolve()},t.prototype.removeItem=function(e){return this.store.removeItem(e),Promise.resolve()},t}(),M=function(){a.Deferred,a.Validation;function e(){f.call(this),this.store={}}return e.prototype=Object.create(f.prototype),e.prototype.constructor=e,e.prototype.implements("PropertyStore"),e.prototype.isSupported=e.isSupported=function(){return Promise.resolve()},e.prototype.getItem=function(e){return Promise.resolve(this.store[e])},e.prototype.setItem=function(e,t){return this.store[e]=t,Promise.resolve()},e.prototype.removeItem=function(e){return delete this.store[e],Promise.resolve()},e.prototype.getKeys=function(){return Promise.resolve(Object.keys(this.store))},e.prototype.clearAll=function(){return this.store={},Promise.resolve(this.store)},e}();if(a.idp.IDP=function(){a.Deferred,a.Validation;function e(e){if(this.constructor===Object)throw new Error("Abstract classes cannot be instantiated");f.call(this),this.providerName=e.providerName,this.projectID=e.projectID}return e.prototype=Object.create(f.prototype),e.prototype.constructor=e,e.prototype.implements("IDP"),e}(),a.idp.AnonymousIDP=function(){a.Deferred;var Validation=a.Validation;a.util.Obj;function e(e){e=e||{},a.idp.IDP.call(this,e),this.providerName="Anonymous"}return e.prototype=Object.create(a.idp.IDP.prototype),e.prototype.constructor=e,e.prototype.getURL=function(){return a.cfg.HOST+a.cfg.res.ANONYMOUSAUTH},e.prototype.getPayload=function(){var e=new Validation,t={projectId:this.projectID};if(this.projectID||e.addError("Missing project ID","Anonymous authentication can only be approved for a specific project ID",{code:Validation.type.MISSINGARG,context:"projectID"}),!e.state)throw e;return t},e}(),a.idp.FlybitsIDP=function(){var e=a.Deferred,Validation=a.Validation,t=(a.cfg,a.util.Api);function r(e){a.idp.IDP.call(this,e),this.providerName="Flybits",this.email=e.email,this.password=e.password,this.firstName=e.firstName,this.lastName=e.lastName}return r.prototype=Object.create(a.idp.IDP.prototype),r.prototype.constructor=r,r.prototype.getURL=function(){return a.cfg.HOST+a.cfg.res.AUTHENTICATE},r.prototype.getPayload=function(){var e=new Validation,t={email:this.email,password:this.password};if(this.email||e.addError("Missing email","No email address provided",{code:Validation.type.MISSINGARG,context:"email"}),this.password||e.addError("Missing password","No email address provided",{code:Validation.type.MISSINGARG,context:"password"}),this.firstName&&!this.lastName?e.addError("Missing last name","First name was supplied without an associated last name.",{code:Validation.type.MISSINGARG,context:"lastName"}):!this.firstName&&this.lastName?e.addError("Missing last name","First name was supplied without an associated last name.",{code:Validation.type.MISSINGARG,context:"lastName"}):this.firstName&&this.lastName&&(t.firstName=this.firstName,t.lastName=this.lastName),this.projectID&&(t.projectId=this.projectID),!e.state)throw e;return t},r.prototype.requestCurrentPasswordReset=r.requestCurrentPasswordReset=function(){var t=new e,r=new Validation;if(a.Session.user&&a.Session.userToken||r.addError("No valid session","",{code:Validation.type.UNAUTHENTICATED}),a.Session._idpType&&"FlybitsIDP"===a.Session._idpType||r.addError("Invalid IDP type","Current session user was not created using the FlybitsIDP",{code:Validation.type.INVALIDARG}),!r.state)return t.reject(r),t.promise;var n=a.Session.user.email;return this.requestPasswordReset(n)},r.prototype.requestPasswordReset=r.requestPasswordReset=function(r){var n=new e,o=a.cfg.HOST+a.cfg.res.REQRESETEMAIL;return r?(t.flbFetch(o,{method:"POST",body:JSON.stringify({email:r}),respType:"empty"}).then(function(){n.resolve()}).catch(function(e){n.reject(e)}),n.promise):(n.reject((new Validation).addError("Missing email","",{code:Validation.type.MISSINGARG})),n.promise)},r.prototype.requestConfirmationEmail=r.requestConfirmationEmail=function(r){var n=new e,o=a.cfg.HOST+a.cfg.res.REQCONFIRMEMAIL;if(!a.Session.userToken)return Promise.reject((new Validation).addError("Session not found.","Must have a valid session to request a confirmation email.",{code:Validation.type.UNAUTHENTICATED}));var i={method:"POST",respType:"empty"};return r||(i.body=JSON.stringify({projectID:a.Session._projectID})),t.flbFetch(o,i).then(function(){n.resolve()}).catch(function(e){n.reject(e)}),n.promise},r}(),a.idp.OAuthIDP=function(){a.Deferred;var Validation=a.Validation;a.util.Obj;function e(e){a.idp.IDP.call(this,e),this.token=e.token}return e.prototype=Object.create(a.idp.IDP.prototype),e.prototype.constructor=e,e.prototype.provider=e.provider={},e.prototype.provider.FACEBOOK=e.provider.FACEBOOK="facebook",e.prototype.provider.GOOGLE=e.provider.GOOGLE="gplus",e.prototype.getURL=function(){return a.cfg.HOST+a.cfg.res.OAUTH},e.prototype.getPayload=function(){var e=new Validation,t={provider:this.providerName,accessToken:this.token};if(this.providerName||e.addError("Missing provider name","An OAuth provider name must be supplied",{code:Validation.type.MISSINGARG,context:"providerName"}),this.token||e.addError("Missing token","No OAuth access token was supplied",{code:Validation.type.MISSINGARG,context:"token"}),this.projectID&&(t.projectId=this.projectID),!e.state)throw e;return t},e}(),a.idp.SignedIDP=function(){a.Deferred;var Validation=a.Validation;a.util.Obj;function e(e){e=e||{},a.idp.IDP.call(this,e),this.providerName="Signed",this.accessToken=e.accessToken,this.signature=e.signature}return e.prototype=Object.create(a.idp.IDP.prototype),e.prototype.constructor=e,e.prototype.getURL=function(){return a.cfg.HOST+a.cfg.res.SIGNEDLOGIN},e.prototype.getPayload=function(){var e=new Validation,t={accessToken:this.accessToken,signature:this.signature};if(this.accessToken||e.addError("Missing access token","",{code:Validation.type.MISSINGARG,context:"accessToken"}),this.signature||e.addError("Missing signature","",{code:Validation.type.MISSINGARG,context:"signature"}),!e.state)throw e;return t},e}(),a.Session=function(){var t=a.util.Api,Validation=a.Validation,r=a.Deferred,User=a.User,n=new a.Deferred,o={ready:n.promise,AUTHHEADER:"x-authorization",user:null,userToken:null,userAgent:null,_idpType:e,_projectID:e,_deviceID:null,_userTokenRetrievedAt:null,_userTokenExpiry:null,connect:function(e){var n=this,o=new r;!e instanceof a.idp.FlybitsIDP&&o.reject((new Validation).addError("Invalid IDP","The provided parameter was not an instance of Flybits.idp.IDP",{code:Validation.type.INVALIDARG}));try{var s=e.getPayload();t.flbFetch(e.getURL(),{method:"POST",body:JSON.stringify(s)}).then(function(t){if(!t.headers[n.AUTHHEADER])throw(new Validation).addError("Session could not be refreshed","Missing/Unreadable token",{context:"x-authorization",code:Validation.type.MALFORMED});var r=new User(t.body);n.user=r,n.setUserToken(t.headers[n.AUTHHEADER]),n._idpType=i(e),n._projectID=e.projectID,o.resolve(r)}).catch(function(e){o.reject(e)})}catch(e){o.reject(e)}return o.promise},disconnect:function(){var e=this,n=new r,o=a.cfg.HOST+a.cfg.res.UNAUTHENTICATE,i={};return i[this.AUTHHEADER]=this.userToken,t.flbFetch(o,{method:"POST",headers:i}).catch(function(){}).then(function(){e.clearSession(),n.resolve()}),n.promise},notifyReady:function(){n.resolve()},resetReady:function(){n.reject(),n=new r,this.ready=n.promise},resolveSession:function(e){var t=new r;if(this.userToken&&e)this.notifyReady(),t.resolve(this.userToken);else{if(this.userToken&&!e)return this.refreshSession();t.reject((new Validation).addError("Session not found.","",{code:Validation.type.UNAUTHENTICATED}))}return t.promise},refreshSession:function(){var e=this,n=new r,o=a.cfg.HOST+a.cfg.res.REFRESHAUTH;return t.flbFetch(o,{respType:"empty"}).then(function(t){if(!t.headers[e.AUTHHEADER])throw(new Validation).addError("Session could not be refreshed","Missing/Unreadable token",{context:"x-authorization",code:Validation.type.MALFORMED});e.setUserToken(t.headers[e.AUTHHEADER]),n.resolve(e.userToken)}).catch(function(e){n.reject(e)}),n.promise},bindSession:function(e){var n=this,o=new r,i=a.cfg.HOST+a.cfg.res.AUTHPROJECT+"?projectId="+e,s=new Validation;return this.user||s.addError("No session","An existing session is required to bind to a project.",{code:Validation.type.UNAUTHENTICATED}),e||s.addError("Missing argument","A project ID is required to bind to a project.",{code:Validation.type.MISSINGARG,context:"projectID"}),s.state?(t.flbFetch(i).then(function(t){if(n._projectID=e,!t.headers[n.AUTHHEADER])throw(new Validation).addError("Session could not be set","Missing/Unreadable token",{context:"x-authorization",code:Validation.type.MALFORMED});n.setUserToken(t.headers[n.AUTHHEADER]),o.resolve(n.userToken)}).catch(function(e){o.reject(e)}),o.promise):(o.reject(s),o.promise)},setUserToken:function(e){if(this.userToken=e,e){this.notifyReady();var r=t.base64Decode(e.split(".")[1]),n=JSON.parse(r);this._userTokenExpiry=n.exp?1e3*n.exp:0,this._userTokenRetrievedAt=(new Date).getTime(),this._projectID=n.tenantID,this._persistState()}else this._userTokenExpiry=null,this._userTokenRetrievedAt=null,this._projectID=null,this._persistState()},clearSession:function(){this.user=null,this.setUserToken(null),this.resetReady()},_persistState:function(){var t=a.store.Property;t.set(a.cfg.store.USERTOKEN,this.userToken),t.set(a.cfg.store.USERTOKENEXP,this._userTokenExpiry),t.set(a.cfg.store.PROJECTID,this._projectID),t.set(a.cfg.store.IDPTYPE,this._idpType),t.set(a.cfg.store.DEVICEID,this._deviceID),t.set(a.cfg.store.USER,this.user?this.user.toJSON():e)},_restoreState:function(){var e=new r,t=this,n=a.store.Property,o=[];return o.push(n.get(a.cfg.store.USERTOKEN)),o.push(n.get(a.cfg.store.USERTOKENEXP)),o.push(n.get(a.cfg.store.PROJECTID)),o.push(n.get(a.cfg.store.DEVICEID)),o.push(n.get(a.cfg.store.IDPTYPE)),o.push(n.get(a.cfg.store.USER)),Promise.settle(o).then(function(r){r[0].status&&(t.userToken=r[0].result),r[1].status&&(t._userTokenExpiry=r[1].result),r[2].status&&(t._projectID=r[2].result),r[3].status&&(t._deviceID=r[3].result),r[4].status&&(t._idpType=r[4].result),r[5].status&&(t.user=new a.User(r[5].result)),e.resolve()}),e.promise}},i=function(e){for(var t=Object.keys(a.idp),r=1;r<t.length;r++)if(e instanceof a.idp[t[r]])return t[r];return""};return o}(),a.context.Manager=function(){var e,t=a.Deferred,Validation=a.Validation,r=a.util.Obj,n=a.util.Api,o=(a.Session,{services:[],reportDelay:6e4,_reportTimeout:null,isReporting:!1,isReportSending:!1,isRestarting:!1,lastReported:null,lastReportAttempted:null,initialize:function(){var r,n,i=new t,s=this;return e=a.util.Obj.debounce(function(){s.startReporting()},s.reportDelay,!0),(r=a.store.Property.get(a.cfg.store.CONTEXTLASTREPORTED).then(function(e){e&&(o.lastReported=+e)}),n=a.store.Property.get(a.cfg.store.CONTEXTLASTREPORTATTEMPTED).then(function(e){e&&(o.lastReportAttempted=+e)}),Promise.settle([r,n])).then(function(){return s.startReporting()}).then(function(){i.resolve()}).catch(function(e){i.reject(e)}),i.promise},register:function(e){var r=this,n=new t;return e instanceof a.context.ContextPlugin?(e.isSupported().then(function(){e.refreshDelay===e.refreshInterval.ONETIME?e.collectState().then(function(){r.services.push(e),n.resolve(e)}).catch(function(e){n.reject(e)}):(e.startService(),r.services.push(e),n.resolve(e))}).catch(function(e){n.reject(e)}),n.promise):(n.reject((new Validation).addError("Invalid Context Plugin","Provided parameter was not a valid Flybits.context.ContextPlugin instance.",{code:Validation.type.NOTSUPPORTED,context:"contextPlugin"})),n.promise)},unregister:function(e){return e instanceof a.context.ContextPlugin&&(r.removeObject(this.services,e),e.stopService()),e},unregisterAll:function(){return this.stopAllServices(),this.services=[],this},stopAllServices:function(){for(var e=this.services,t=0;t<e.length;t++)e[t].stopService();return this},startAllServices:function(){for(var e=this.services,t=0;t<e.length;t++)e[t].startService();return this},startReporting:function(){var e=new t,r=this;if(this.isRestarting)throw(new Validation).addError("Already restarting service","",{code:Validation.type.UNEXPECTED,context:"context.Manager"});return this.isRestarting=!0,r.stopReporting(),(a.Session.userToken?Promise.resolve(a.Session.userToken):a.Session.resolveSession()).then(function(){var t;(t=function(){r.report().catch(function(e){}).then(function(){r.isReporting&&(r._reportTimeout=setTimeout(function(){t()},r.reportDelay))}),r.isReporting=!0})(),e.resolve()}).catch(function(t){e.reject(t)}).then(function(){r.isRestarting=!1}),e.promise},stopReporting:function(){return this.isReporting=!1,clearTimeout(this._reportTimeout),this},_gatherAllData:function(){for(var e=new t,r=this.services,n=[],o=[],i=[],s=0;s<r.length;s++)!function(e){var t=e._fetchCollected();i.push(t),t.then(function(t){Array.prototype.push.apply(n,t.data),o.push({serviceRef:e,keys:t.keys})})}(r[s]);return Promise.settle(i).then(function(){e.resolve({data:n,keys:o})}),e.promise},_sendReport:function(e){var r=new t,o=a.cfg.HOST+a.cfg.res.CONTEXT;return n.flbFetch(o,{method:"POST",body:JSON.stringify(e),respType:"empty"}).then(function(e){r.resolve()}).catch(function(e){r.reject(e)}),r.promise},_cleanupServices:function(e){for(var r,n=new t,o=[],i=0;i<e.length;i++)r=e[i],o.push(r.serviceRef._deleteCollected(r.keys));return Promise.settle(o).then(function(){n.resolve()}),n.promise},report:function(){var e=this,r=new t,n=[];return this._gatherAllData().then(function(t){if(!t.data||!t.data.length)throw(new Validation).addError("No context to upload.","",{code:Validation.type.NOTFOUND});return n=t.keys,e.isReportSending=!0,e._sendReport(t.data)}).then(function(){return e.lastReported=Date.now(),a.store.Property.set(a.cfg.store.CONTEXTLASTREPORTED,e.lastReported),e._cleanupServices(n)}).then(function(){r.resolve()}).catch(function(e){e instanceof Validation?r.reject(e):r.reject((new Validation).addError("Context report failed.",e,{code:Validation.UNEXPECTED}))}).then(function(){e.lastReportAttempted=Date.now(),a.store.Property.set(a.cfg.store.CONTEXTLASTREPORTATTEMPTED,e.lastReportAttempted),e.isReportSending=!1}),r.promise},warmReporting:function(){var t=this.lastReported?Date.now()-this.lastReported:this.reportDelay+1;this.isReporting&&!this.isReportSending&&t>this.reportDelay&&e.apply(this)}});return o}(),a.context.ContextPlugin=function(){var e=a.Deferred,Validation=a.Validation;function t(e){if(this.constructor===Object)throw new Error("Abstract classes cannot be instantiated");f.call(this),this._refreshTimeout=null,this.refreshDelay=e&&e.refreshDelay?e.refreshDelay:this.refreshInterval.ONEMINUTE,this.maxStoreSize=e&&e.maxStoreSize?e.maxStoreSize:80,this.maxStoreAge=e&&e.maxStoreAge?e.maxStoreAge:864e5,this.isServiceRunning=!1,this.collectHistorical=e&&e.collectHistorical,this.lastCollected=-1,this.lastLocalValue=null,this.lastLocalKey=null,this._store=new a.store.Record(this.TYPEID)}return t.prototype=Object.create(f.prototype),t.prototype.constructor=t,t.prototype.implements("ContextPlugin"),t.prototype.refreshInterval=t.refreshInterval={},t.prototype.refreshInterval.ONETIME=t.refreshInterval.ONETIME=-42,t.prototype.refreshInterval.THIRTYSECONDS=t.refreshInterval.THIRTYSECONDS=3e4,t.prototype.refreshInterval.ONEMINUTE=t.refreshInterval.ONEMINUTE=6e4,t.prototype.refreshInterval.ONEHOUR=t.refreshInterval.ONEHOUR=36e5,t.prototype.refreshInterval.ONEDAY=t.refreshInterval.ONEDAY=864e5,t.prototype.TYPEID=t.TYPEID="ctx.sdk.generic",t.prototype.startService=function(){var e;return this.stopService(),(e=function(t){t.collectState().catch(function(e){}).then(function(){t.isServiceRunning&&(t._refreshTimeout=setTimeout(function(){e(t)},t.refreshDelay))}),t.isServiceRunning=!0})(this),this},t.prototype.stopService=function(){return this.isServiceRunning=!1,clearTimeout(this._refreshTimeout),this},t.prototype.collectState=function(){var t=new e,r=this,n=this._store,o=0;return n.ready.then(function(){return n.keys()}).then(function(e){return o=e.length,r.getState()}).then(function(e){if(!e)throw(new Validation).addError("Empty context state collected","",{code:Validation.type.NOTFOUND});return r._saveState(e)}).then(function(){r.lastCollected=(new Date).getTime(),o>=r.maxStoreSize&&r._validateStoreState(),t.resolve()}).catch(function(e){t.reject(e)}),t.promise},t.prototype.setState=function(t){var r=new e,n=this,o=this._store,i=0;return o.ready.then(function(){return o.keys()}).then(function(e){return i=e.length,n._saveState(t)}).then(function(){n.lastCollected=(new Date).getTime(),i>=n.maxStoreSize&&n._validateStoreState(),r.resolve()}).catch(function(e){console.error(">",n,e),r.reject()}),r.promise},t.prototype._validateStoreState=function(){var t=this,r=new e,n=[],o=this._store;return o.keys().then(function(e){var i=e,s=(new Date).getTime(),a=i.length-t.maxStoreSize;if(i.sort(function(e,t){return+e.split("-")[1]-+t.split("-")[1]}),a>0)for(var c=0;c<a;c++)n.push(o.remove(i.shift()));for(;i.length>0&&s-i[0]>=t.refreshInterval.ONEDAY;)n.push(o.remove(i.shift()));Promise.settle(n).then(function(){r.resolve()})}).catch(function(){r.reject()}),r.promise},t.prototype._fetchCollected=function(){var t=this,r=new e,n=[],o=[],i=this._store;return i.keys().then(function(e){var s;(s=function(){if(e.length<=0)r.resolve({data:n,keys:o});else{var a=e.pop();o.push(a),i.get(a).then(function(e){var r=+a.split("-")[1];n.push({timestamp:Math.round(r/1e3),dataTypeID:t.TYPEID,value:t._toServerFormat(e)})}).catch(function(){}).then(function(){s()})}})()}).catch(function(e){r.reject(e)}),r.promise},t.prototype._deleteCollected=function(t){var r,n=this._store,o=new e;return(r=function(){if(t.length<=0)o.resolve();else{var e=t.pop();n.remove(e).catch(function(){}).then(function(){r()})}})(),o.promise},t.prototype._generateKey=t._generateKey=function(){var e=(new Date).getTime();return a.util.Obj.guid(1)+"-"+e},t.prototype._cleanHistorical=function(e){this.lastLocalKey&&JSON.stringify(this.lastLocalValue)===JSON.stringify(e)&&this._store.remove(this.lastLocalKey)},t.prototype._saveState=function(e){var t=this,r=this._generateKey();this.collectHistorical||this._cleanHistorical(e);var n=this._store.set(r,e);return n.then(function(){t.lastLocalKey=r,t.lastLocalValue=e,a.context.Manager.warmReporting()}),n},t.prototype._toServerFormat=function(e){if(e){e=a.util.Obj.extend({},e);for(var t=Object.keys(e),r=0;r<t.length;r++){var n=t[r];n.indexOf(".")>-1&&(e["query."+n]=e[n],delete e[n])}}return e},t}(),a.context.Connectivity=function(){var e=a.Deferred,t=a.util.Obj;function r(e){a.context.ContextPlugin.call(this,e),e&&(this.opts=t.extend({},this.opts,e))}return r.prototype=Object.create(a.context.ContextPlugin.prototype),r.prototype.constructor=r,r.prototype.TYPEID=r.TYPEID="ctx.sdk.network",r.isSupported=r.prototype.isSupported=function(){var t=new e;return t.resolve(),t.promise},r.getState=r.prototype.getState=function(){var t=new e,r=this;return"object"==typeof navigator&&"onLine"in navigator&&!this.opts.hardCheck?t.resolve({state:navigator.onLine?r.state.CONNECTED:r.state.DISCONNECTED}):fetch(a.cfg.HOST+"/ping").then(function(e){t.resolve({state:r.state.CONNECTED})}).catch(function(e){t.resolve({state:r.state.DISCONNECTED})}),t.promise},r._toServerFormat=r.prototype._toServerFormat=function(e){return{connectionType:e.state}},r.state=r.prototype.state={},r.state.DISCONNECTED=r.prototype.state.DISCONNECTED=-1,r.state.CONNECTED=r.prototype.state.CONNECTED=-99,r.opts=r.prototype.opts={hardCheck:!1},r}(),a.context.Location=function(){var e=a.Deferred,t=a.util.Obj;function r(e){a.context.ContextPlugin.call(this,e),e&&(this.opts=t.extend({},this.opts,e))}return r.prototype=Object.create(a.context.ContextPlugin.prototype),r.prototype.constructor=r,r.prototype.TYPEID=r.TYPEID="ctx.sdk.location",r.isSupported=r.prototype.isSupported=function(){var t=new e;return"object"==typeof navigator&&navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){t.resolve()},function(e){console.error(">",e),t.reject((new a.Validation).addError("Location Sensing Not Supported",e.message?e.message:"User denied"))}):t.reject((new a.Validation).addError("Location Sensing Not Supported","Device GeoLocation API not found.")),t.promise},r.getState=r.prototype.getState=function(){var t=new e;return navigator.geolocation.getCurrentPosition(function(e){t.resolve({coords:{latitude:e.coords.latitude,longitude:e.coords.longitude,accuracy:e.coords.accuracy},timestamp:e.timestamp})},function(e){console.error(">",e),t.reject((new a.Validation).addError("Location could not be resolved"))},this.opts),t.promise},r._toServerFormat=r.prototype._toServerFormat=function(e){return{lat:e.coords.latitude,lng:e.coords.longitude}},r.opts=r.prototype.opts={maximumAge:12e5},r}(),a.analytics.Event=(S=a.util.Obj,((I=function(e){h.call(this,e),this._tmpID=S.guid(1)+"-"+Date.now(),this.type=this.types.DISCRETE,this.name="",this.loggedAt=new Date,this.properties={},this._internal={},this._isInternal=!1,e&&this.fromJSON(e)}).prototype=Object.create(h.prototype)).constructor=I,I.prototype.implements("Serializable"),I.prototype.types=I.types={},I.prototype.types.DISCRETE=I.types.DISCRETE="event_discrete",I.prototype.types.TIMEDSTART=I.types.TIMEDSTART="event_timestart",I.prototype.types.TIMEDEND=I.types.TIMEDEND="event_timeend",I.prototype.TIMEDREFID=I.TIMEDREFID="timedRef",I.prototype.OSTYPE=I.OSTYPE="osType",I.prototype.OSVERSION=I.OSVERSION="osVersion",I.prototype.UID=I.UID="uid",I.prototype._setProp=function(e,t,r){return void 0===r||null===r?(delete e[t],this):(e[t]=r,this)},I.prototype.setProperty=function(e,t){return this._setProp(this.properties,e,t)},I.prototype._setInternalProperty=function(e,t){return this._setProp(this._internal,e,t)},I.prototype.fromJSON=function(e){this.type=e.type||this.types.DISCRETE,this.name=e.name,this.loggedAt=e.loggedAt?new Date(e.loggedAt):new Date,this.properties=e.properties||{},this._internal=e.flbProperties||{},this._isInternal=e.isFlybits||!1},I.prototype.toJSON=function(){return{type:this.type,name:this.name,loggedAt:this.loggedAt.getTime(),properties:this.properties,flbProperties:this._internal,isFlybits:this._isInternal}},I),a.analytics.Manager=function(){var e=a.Deferred,Validation=a.Validation,t=a.Session,r=a.analytics.Event,n=function(e){return"object"==typeof window?(e._setInternalProperty(r.OSTYPE,"browser"),window.hasOwnProperty("navigator")&&e._setInternalProperty(r.OSVERSION,navigator.userAgent)):(e._setInternalProperty(r.OSTYPE,"node"),"undefined"!=typeof process&&e._setInternalProperty(r.OSVERSION,process.version)),t.user&&e._setInternalProperty(r.UID,t.user.id),e},o={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5},i=new e,s={ready:i.promise,maxStoreSize:100,reportDelay:36e5,reportDelayUnit:"milliseconds",lastReported:null,lastReportAttempted:null,_reportTimeout:null,_analyticsStore:null,_uploadChannel:null,_timedEventCache:{},isReporting:!1,initialize:function(){var t=new e,r=this;return this._analyticsStore=new a.analytics.RecordsStore({maxStoreSize:a.cfg.analytics.MAXSTORESIZE}),this._uploadChannel=new a.analytics.DefaultChannel,this._analyticsStore._store.ready.then(function(){return e=a.store.Property.get(a.cfg.store.ANALYTICSLASTREPORTED).then(function(e){e&&(s.lastReported=+e)}),t=a.store.Property.get(a.cfg.store.ANALYTICSLASTREPORTATTEMPTED).then(function(e){e&&(s.lastReportAttempted=+e)}),Promise.settle([e,t]);var e,t}).then(function(){return r.startReporting()}).then(function(){i.resolve(),t.resolve()}).catch(function(e){t.reject(e)}),t.promise},stopReporting:function(){return this.isReporting=!1,clearTimeout(this._reportTimeout),this},startReporting:function(){var t=new e,r=this;return r.stopReporting(),(a.Session.userToken?Promise.resolve(a.Session.userToken):a.Session.resolveSession()).then(function(){var e;(e=function(){r.report().catch(function(e){}).then(function(){var t,n;r.isReporting&&(r._reportTimeout=setTimeout(function(){e()},(t=r.reportDelay,n=r.reportDelayUnit,t*(o[n]||1))))}),r.isReporting=!0})(),t.resolve()}).catch(function(e){t.reject(e)}),t.promise},report:function(){var t,r=new e,n=this;return this._analyticsStore.getAllEvents().then(function(e){if((t=e.map(function(e){return e._tmpID})).length<1)throw(new Validation).addError("No analytics to upload.","",{code:Validation.type.NOTFOUND});return n._uploadChannel.uploadEvents(e)}).then(function(){return n.lastReported=Date.now(),a.store.Property.set(a.cfg.store.ANALYTICSLASTREPORTED,n.lastReported),n._analyticsStore.clearEvents(t)}).then(function(){r.resolve()}).catch(function(e){e instanceof Validation&&e.firstError().code!==Validation.type.NOTFOUND&&console.error("> analytics report error",e),r.reject(e)}).then(function(){n.lastReportAttempted=Date.now(),a.store.Property.set(a.cfg.store.ANALYTICSLASTREPORTATTEMPTED,n.lastReportAttempted)}),r.promise},logEvent:function(e,t){var o=new r({name:e,type:r.types.DISCRETE,properties:t});return n(o),this._analyticsStore.addEvent(o)},_logInt:function(e,t,o){var i=new r({name:e,type:r.types.DISCRETE,properties:t,isFlybits:!0,flbProperties:o});return n(i),this._analyticsStore.addEvent(i)},startTimedEvent:function(t,o){var i=this,s=new e,a=new r({name:t,type:r.types.TIMEDSTART,properties:o});return n(a),a._setInternalProperty(r.TIMEDREFID,a._tmpID),this._analyticsStore.addEvent(a).then(function(){i._timedEventCache[a._tmpID]=a,s.resolve(a._tmpID)}).catch(function(e){s.reject(e)}),s.promise},_logStartInt:function(t,o,i){var s=this,a=new e,c=new r({name:t,type:r.types.TIMEDSTART,properties:o,isFlybits:!0,flbProperties:i});return n(c),c._setInternalProperty(r.TIMEDREFID,c._tmpID),this._analyticsStore.addEvent(c).then(function(){s._timedEventCache[c._tmpID]=c,a.resolve(c._tmpID)}).catch(function(e){a.reject(e)}),a.promise},endTimedEvent:function(t){var n=this,o=new e,i=n._timedEventCache[t];if(!t||!i)return o.reject((new Validation).addError("No Timed Event Found","No corresponding start event was found for provided reference.",{code:Validation.type.NOTFOUND,context:t})),o.promise;var s=new r({name:i.name,type:r.types.TIMEDEND,properties:i.properties});return s._internal=i._internal,s._isInternal=i._isInternal,this._analyticsStore.addEvent(s).then(function(){delete n._timedEventCache[t],o.resolve()}).catch(function(e){o.reject(e)}),o.promise},_logEndInt:function(e){return this.endTimedEvent(e)}};return s}(),a.analytics.AnalyticsStore=function(){a.Deferred,a.Validation;var e=function(e){if(this.constructor===Object)throw new Error("Abstract classes cannot be instantiated");this.maxStoreSize=e&&e.maxStoreSize?e.maxStoreSize:100};return e.prototype={implements:function(e){this._interfaces||(this._interfaces=[]),this._interfaces.push(e)}},e}(),a.analytics.RecordsStore=function(){var e=a.Deferred,Validation=a.Validation,t=a.util.Obj,r=a.analytics.Event;function n(e){a.analytics.AnalyticsStore.call(this,e),e&&(this.opts=t.extend({},e)),this._store=new a.store.Record(this.STOREID)}return n.prototype=Object.create(a.analytics.AnalyticsStore.prototype),n.prototype.constructor=n,n.prototype.STOREID=n.STOREID="flb.analytics",n.prototype.addEvent=function(t){var n=new e,o=this,i=this._store,s=0;return t instanceof r?(i.keys().then(function(e){return s=e.length,o._saveState(t)}).then(function(){s>=o.maxStoreSize?o._validateStoreState().then(function(){n.resolve()}):n.resolve()}).catch(function(e){n.reject(e)}),n.promise):(n.reject((new Validation).addError("Invalid Argument","Must be an instance of an analytics Event",{code:Validation.type.INVALIDARG})),n.promise)},n.prototype.getEvent=function(t){var n=new e;return this._store.get(t).then(function(e){if(e){var o=new r(e);o._tmpID=t,n.resolve(o)}else n.resolve()}).catch(function(e){n.reject(e)}),n.promise},n.prototype.clearEvents=function(t){var r,n=this._store,o=new e;return(r=function(){if(t.length<=0)o.resolve();else{var e=t.pop();n.remove(e).catch(function(){}).then(function(){r()})}})(),o.promise},n.prototype.clearAllEvents=function(){return this._store.clear()},n.prototype.getAllEvents=function(){var t=new e,n=[],o=this._store;return o.keys().then(function(e){var i=function(){if(e.length){var s=e.pop();o.get(s).then(function(e){var t=new r(e);t._tmpID=s,n.push(t)}).catch(function(){}).then(function(){i()})}else t.resolve(n)};i()}),t.promise},n.prototype._saveState=function(e){return this._store.set(e._tmpID,e.toJSON())},n.prototype._validateStoreState=function(){var t=this,r=new e,n=[],o=this._store;return o.keys().then(function(e){var i=e,s=((new Date).getTime(),i.length-t.maxStoreSize);if(i.sort(function(e,t){return+e.split("-")[1]-+t.split("-")[1]}),s>0)for(var a=0;a<s;a++)n.push(o.remove(i.shift()));Promise.settle(n).then(function(){r.resolve()})}).catch(function(){r.reject()}),r.promise},n}(),a.analytics.UploadChannel=function(){a.store.Session;var e=function(e){if(this.constructor===Object)throw new Error("Abstract classes cannot be instantiated")};return e.prototype={implements:function(e){this._interfaces||(this._interfaces=[]),this._interfaces.push(e)}},e}(),a.analytics.DefaultChannel=(D=a.Deferred,a.Validation,T=a.util.Api,O=a.Session,a.analytics.Event,((A=function(e){a.analytics.UploadChannel.call(this,e),this.sessionKey=null,this.HOST=a.cfg.analytics.CHANNELHOST,this.channelKey=a.cfg.analytics.CHANNELKEY,this.appID=a.cfg.analytics.APPID}).prototype=Object.create(a.analytics.UploadChannel.prototype)).constructor=A,A.prototype.initSession=function(){var e=new D,t=this,r=this.HOST+"/session?key="+this.channelKey;return T.fetch(r,{method:"GET",respType:"json"}).then(function(r){t.sessionKey=r.body.key,e.resolve()}).catch(function(t){e.reject(t)}),e.promise},A.prototype._preparePayload=function(e){return{deviceID:O.deviceID,data:e.map(function(e){var t=e.toJSON();return t.properties._uid=O.user.id,t})}},A.prototype._upload=function(e){var t=new D,r=this.HOST+"/events";return T.fetch(r,{method:"POST",headers:{key:this.sessionKey,appid:this.appID,"Content-Type":"application/json"},body:JSON.stringify(e),respType:"empty"}).then(function(e){t.resolve()}).catch(function(e){t.reject(e)}),t.promise},A.prototype.uploadEvents=function(e){var t=this,r=this._preparePayload(e),n=Promise.resolve();return this.sessionKey||(n=this.initSession()),n.then(function(){return t._upload(r)})},A),a.api.Content=function(){var t=a.util.Obj,r=a.util.Api,Validation=a.Validation,n=a.Deferred,Content=(a.store.Session,a.Content),o=null;return{getPaging:function(){return o},get:function(e,t){var o=new n,i=a.cfg.HOST+a.cfg.res.CONTENTS,s=t&&t.localization?t.localization:"all";if(!e||""===e)throw(new Validation).addError("Missing Argument","No Content ID specified",{code:Validation.type.MISSINGARG,context:"id"});return i=i+"/"+e+"?"+r.toURLParams({data:!0}),r.flbFetch(i,{method:"GET",headers:{"accept-language":s}}).then(function(e){if(e&&e.body){var t;try{t=Content.getInstance(e.body)}catch(t){o.reject((new Validation).addError("Server model Parsing Failed","Failed to parse single content server model.",{code:Validation.type.MALFORMED,context:e}))}o.resolve({result:t})}else o.reject((new Validation).addError("Server Request Failed","Failed to retrieve single content from server",{code:Validation.type.MALFORMED}))}).catch(function(e){o.reject(e)}),o.promise},getAll:function(i){var s=new n,c=a.cfg.HOST,u={data:!0},p=i?t.extend({},i):e;i&&i.managed?(c+=a.cfg.res.CONTENTS,delete i.sortBy):i&&i.location?c+=a.cfg.res.CONTENTS:c+=a.cfg.res.RELEVANTCONTENTS;var l="all";return i&&(l=i.localization?i.localization:"all",delete i.localization,u=function(e){var t=new Validation,r={};if(!e)return r;if(e.managed&&(r.managementMode=!0),e.paging&&(e.paging.limit||e.paging.offset?(e.paging.limit>0&&(r.limit=e.paging.limit),e.paging.offset>=0&&(r.offset=e.paging.offset)):t.addError("Missing Argument","paging request parameter object must contain at least a limit or offset property.",{code:Validation.type.MISSINGARG,context:"paging.limit, paging.offset"})),e.sortBy){var n=e.sortBy.key,o=e.sortBy.order;n?"evaluatedAt"!==n&&t.addError("Invalid Argument","Content cannot be sorted by this property:"+n,{code:Validation.type.INVALIDARG,context:"sortBy.key"}):t.addError("Missing Argument","sortBy requires a key to sort by.",{code:Validation.type.MISSINGARG,context:"sortBy.key"}),r.orderby="evaluatedAt",o&&"asc"!==o&&"ascending"!==o&&"desc"!==o&&"descending"!==o?t.addError("Invalid Argument","Content sort direction invalid.  Supported values are: asc or ascending or desc or descending",{code:Validation.type.INVALIDARG,context:"sortBy.order"}):n&&!o&&(o="desc"),"ascending"===o?o="asc":"descending"===o&&(o="desc"),r.sortorder=o}if(e.templateID&&(r.templateId=e.templateID),e.labels&&(e.labels.constructor!==Array?t.addError("Invalid Argument","Labels must be an array of strings",{code:Validation.type.INVALIDARG,context:"labels"}):e.labels.length>0&&(r.labels=e.labels.join(","))),e.hasOwnProperty("data")&&(r.data=e.data),e.location&&(e.location.key?r.loc=e.location.key:t.addError("Missing Argument","location query requires a key to sort by.",{code:Validation.type.MISSINGARG,context:"location.key"}),e.location.lat?r.lat=e.location.lat:t.addError("Missing Argument","location query requires a latitude.",{code:Validation.type.MISSINGARG,context:"location.lat"}),e.location.lng?r.lng=e.location.lng:t.addError("Missing Argument","location query requires a longitude.",{code:Validation.type.MISSINGARG,context:"location.lng"}),e.location.radius?r.radius=e.location.radius:r.radius=1e3),!t.state)throw t;return r}(i=t.extend(u,i))),""!==(u=r.toURLParams(u))&&(c+="?"+u),r.flbFetch(c,{method:"GET",headers:{"accept-language":l}}).then(function(e){if(e&&e.body&&e.body.data&&e.body.data.length>=0){var t=r.parsePaging(e.body);o=t;var n=e.body.data.map(function(e){try{return Content.getInstance(e)}catch(t){s.reject((new Validation).addError("Request Failed","Failed to parse server model.",{code:Validation.type.MALFORMED,context:e}))}});s.resolve({result:n,nextPageFn:r.createNextPageCall(a.api.Content.getAll,p,t)})}else s.reject((new Validation).addError("Server Request Failed","Failed to retrieve contents from server",{code:Validation.type.MALFORMED}))}).catch(function(e){s.reject(e)}),s.promise}}}(),a.api.ContentData=function(){var t=a.util.Obj,r=a.util.Api,Validation=a.Validation,n=a.Deferred,Content=(a.store.Session,a.Content),ContentData=a.ContentData,PagedData=a.PagedData,o=null;function i(e){var t={};if(!e)return t;e.paging&&Object.keys(e.paging).forEach(function(r){var n=e.paging[r];if(n.constructor===Object){var o=n.limit,i=n.offset;if(!o&&!i)throw(new Validation).addError("Missing Argument","paging request parameter object must contain at least a limit or offset property.",{code:Validation.type.MISSINGARG,context:"pagingLimit, pagingOffset"});if(o>0)t[r+".limit"]=o;if(e.paging[r].offset>=0)t[r+".offset"]=i}else"limit"===r&&n>0&&(t.limit=n),"offset"===r&&n>=0&&(t.offset=n)});e.sortBy&&(Object.keys(e.sortBy).forEach(function(r){var n=e.sortBy[r];if(n.constructor===Object){var o=n.key,i=n.order;if(!o)throw(new Validation).addError("Missing Argument","orderBy requires a ContentData model property key to order by.",{code:Validation.type.MISSINGARG,context:"orderBy.key"});if(t[r+".sortBy"]=o,i&&"asc"!==i&&"desc"!==i)throw(new Validation).addError("Invalid Argument","Content cannot be ordered by in such way(MUST BE asc or desc)",{code:Validation.type.INVALIDARG,context:"orderBy.order"});t[r+".order"]=i}else"key"===r&&(t.key=n),"order"===r&&(t.key=n)}),e.hasOwnProperty("data")&&(t.data=e.data));return t}return{getPaging:function(){return o},get:function(o){var s=new n,c=a.cfg.HOST+a.cfg.res.CONTENTS,u=o?o.contentID:e,p=o?o.contentDataID:e,l=o&&o.localization?o.localization:"all";if(!u||""===u)throw(new Validation).addError("Missing Argument","No Content ID specified to find Data",{code:Validation.type.MISSINGARG,context:u});if(!p||""===p)throw(new Validation).addError("Missing Argument","No Content Data ID specified to find Data",{code:Validation.type.MISSINGARG,context:"contentDataID"});if(o){t.extend({},o);delete o.contentID,delete o.localization,delete o.contentDataID,o=i(o)}return c=c+"/"+u+"/data/"+p,""!==(o=r.toURLParams(o))&&(c+="?"+o),r.flbFetch(c,{method:"GET",headers:{"accept-language":l}}).then(function(e){if(e&&e.body){var t,r=new Path;r.append(new Content({id:u}));try{t=new ContentData(e.body,r)}catch(t){s.reject((new Validation).addError("Server model Parsing Failed","Failed to parse single content server model.",{code:Validation.type.MALFORMED,context:e}))}s.resolve({result:t})}else s.reject((new Validation).addError("Server Request Failed","Failed to retrieve single content from server",{code:Validation.type.MALFORMED}))}).catch(function(e){s.reject(e)}),s.promise},getAll:function(s){var c=new n,u=a.cfg.HOST+a.cfg.res.CONTENTS,p=s?s.contentID:e,l=s&&s.localization?s.localization:"all";if(!p||""===p)throw(new Validation).addError("Missing Argument","No Content ID specified to find Data",{code:Validation.type.MISSINGARG,context:"contentID"});if(s){var d=t.extend({},s);delete s.contentID,delete s.localization,data=i(s)}return u=u+"/"+p+"/data",data=r.toURLParams(data),""!==data&&(u+="?"+data),r.flbFetch(u,{method:"GET",headers:{"accept-language":l}}).then(function(e){if(e&&e.body&&e.body.data&&e.body.data.length>=0){var t=r.parsePaging(e.body);o=t;var n=e.body.data.map(function(e){var t=new Path;t.append(new Content({id:p}));try{return new ContentData(e,t)}catch(t){c.reject((new Validation).addError("Request Failed","Failed to parse server model.",{code:Validation.type.MALFORMED,context:e}))}});c.resolve({result:n,contentID:p,nextPageFn:r.createNextPageCall(a.api.ContentData.getAll,d,t)})}else c.reject((new Validation).addError("Server Request Failed","Failed to retrieve contents from server",{code:Validation.type.MALFORMED}))}).catch(function(e){c.reject(e)}),c.promise},getPagedData:function(e){var o=new n,s=a.cfg.HOST+"/kernel",c=e&&e.localization?e.localization:"all",u=new Validation;if(e&&e.path||u.addError("Missing Argument","No Path provided for nested data",{code:Validation.type.MISSINGARG,context:"path"}),e&&e.key||u.addError("Missing Argument","No field key provided for nested data array.",{code:Validation.type.MISSINGARG,context:"key"}),!u.state)throw u.setStackTrace();s+=e.path.serialize()+"?field="+e.key;var p=t.extend({},e);if(delete e.localization,delete e.path,delete e.key,e.paging){var l=e.paging;e.paging={},e.paging[p.key]=l}var d=i(e);return""!==(d=r.toURLParams(d))&&(s+="&"+d),r.flbFetch(s,{method:"GET",headers:{"accept-language":c}}).then(function(e){var t=e.body[p.key],n=r.parsePaging(e.body,p.key+".pagination"),i=new PagedData;i.fromJSON(t),o.resolve({result:i.data,nextPageFn:r.createNextPageCall(a.api.ContentData.getPagedData,p,n)})}).catch(function(e){o.reject(e)}),o.promise},submitData:function(e){var t=new n,o=a.cfg.HOST+"/kernel";o+=e.path.serialize();var i=e.id?"PUT":"POST";return e instanceof a.ContentData?r.flbFetch(o,{method:i,body:JSON.stringify(e.toJSON())}).then(function(e){t.resolve(e)}).catch(function(e){t.reject(e)}):t.reject((new Validation).addError("Invalid argument","Can only submit ContentData types.",{code:Validation.type.INVALIDARG,context:e})),t.promise}}}(),a.api.User=(w=a.util.Api,a.util.Obj,a.Validation,N=a.Deferred,User=a.User,R=a.Session,{getSignedInUser:function(){var e=new N,t=a.cfg.HOST+a.cfg.res.AUTHUSER,r=R.userToken,n={};return n[R.AUTHHEADER]=r,w.flbFetch(t,{method:"GET",headers:n}).then(function(t){var r=new User(t.body);R.user=r,e.resolve(r)}).catch(function(t){e.reject(t)}),e.promise}}),"object"==typeof window)window.Flybits=a,a.initFile=a.initFile.browser;else if("object"==typeof exports&&"undefined"!=typeof module){var k=require("fs"),U=require("node-persist");global.atob=require("atob"),a.initFile=a.initFile.server,module.exports=a}else"function"==typeof define&&define.amd?define(function(){return a.init=a.init.server,a}):(a.init=a.init.server,global.Flybits=a);"string"==typeof __dirname&&(a.cfg.store.RESOURCEPATH=__dirname+"/res"),a.store.Property.init();var L=new a.Deferred;a.ready=L.promise}();